<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/utils/debounce.html">
<link rel="import" href="/bower_components/polymer/lib/utils/flattened-nodes-observer.html">

<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="layouters/default-layouter.html">

<dom-module id="curium-responsive-layout">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
      }
    </style>
    <curium-responsive-layout-default-layouter
      id="default-layouter"
      layout-map="{{layoutMap}}">
    </curium-responsive-layout-default-layouter>
    <slot></slot>
  </template>

  <script>
    /**
     * `curium-responsive-layout`
     * An element designed to make building responsive layout easier
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class CuriumResponsiveLayout extends Polymer.mixinBehaviors(Polymer.IronResizableBehavior, Polymer.Element) {

      static get is() { return 'curium-responsive-layout'; }

      static get properties() {
        return {
          layouter: {
            type: String, // or Object via JS
            value: 'default',
            observer: '_onLayouterChanged'
          },
          resizeDelay: {
            type: Number,
            value: 200
          },

          // Default Layouter parameter
          layoutMap: {
            type: Object
          },

          _layouterInstance: Object
        };
      }

      ready() {
        super.ready();
        this.addEventListener('iron-resize', e => this._onIronResize(e));
      }

      _onLayouterChanged(layouter) {
        let instance = null;
        if (layouter === 'default') {
          instance = this.$['default-layouter'];
        } else if (typeof layouter === 'string') {
          instance = this._getParentRoot().querySelector(layouter);
        } else if (layouter !== null && typeof layouter === 'object') {
          instance = layouter;
        }
        if (this._layouterInstance !== instance) {
          this._layouterInstance = instance;
          this.updateLayout();
        }
      }

      _onIronResize(evt) {
        this._resizeDebouncer = Polymer.Debouncer.debounce(this._resizeDebouncer, Polymer.Async.timeOut.after(this.resizeDelay), () => {
          this.updateLayout();
        });
      }

      updateLayout() {
        if (this._layouterInstance) {
          this._layouterInstance.layoutContainer(this._getContainer(), this._getContainerWidth(), this._getContainerChildNodes());
        }
      }

      _getParentRoot() {
        let node = this.parent;
        while (node.parent) {
          node = node.parent;
        }
        return node;
      }

      _getContainer() {
        return this;
      }
      _getContainerWidth() {
        return this._getContainer().clientWidth;
      }
      _getContainerChildNodes() {
        return Polymer.FlattenedNodesObserver.getFlattenedNodes(this._getContainer());
      }

    }

    window.customElements.define(CuriumResponsiveLayout.is, CuriumResponsiveLayout);
    {
      window.Curium = window.Curium || {};

      let currentData = null;
      if (Curium.CuriumResponsiveLayout) currentData = Curium.CuriumResponsiveLayout;

      Curium.CuriumResponsiveLayout = CuriumResponsiveLayout;

      if (currentData) {
        for (let prop in currentData) {
          Curium.CuriumResponsiveLayout[prop] = currentData[prop];
        }
      }
    }
  </script>
</dom-module>
